<div class="management-container">
  <div class="management-header">
    <div class="header-title">
      <i class="pi pi-star-fill"></i>
      <h2>Cấu hình Ưu Tiên</h2>
    </div>
    <button pButton type="button" icon="pi pi-plus" label="Thêm Cấu hình" class="p-button-success" (click)="openAddDialog()"></button>
  </div>

  <p-table [value]="prioritySettings" styleClass="custom-table">
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 15%">Dịch vụ</th>
        <th style="width: 15%">Phòng</th>
        <th style="width: 20%">Chiến lược</th>
        <th style="width: 15%">Khoảng cách</th>
        <th style="width: 12%">Trạng thái</th>
        <th style="width: 23%">Thao tác</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-setting>
      <tr>
        <td>{{ getServiceName(setting.serviceId) }}</td>
        <td>{{ getRoomName(setting.roomId) }}</td>
        <td>{{ getStrategyLabel(setting.strategy) }}</td>
        <td class="text-center">{{ setting.interleaveInterval }}</td>
        <td class="text-center">
          <p-tag [value]="setting.isActive ? 'Kích hoạt' : 'Tắt'" 
            [severity]="setting.isActive ? 'success' : 'danger'"></p-tag>
        </td>
        <td class="text-center">
          <button pButton type="button" icon="pi pi-pencil" class="p-button-rounded p-button-text p-button-sm" 
            (click)="openEditDialog(setting)" pTooltip="Sửa" tooltipPosition="top"></button>
          <button pButton type="button" icon="pi pi-trash" class="p-button-rounded p-button-text p-button-danger p-button-sm" 
            (click)="deleteSetting(setting)" pTooltip="Xóa" tooltipPosition="top"></button>
        </td>
      </tr>
    </ng-template>
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="6" class="text-center" style="padding: 2rem;">
          <i class="pi pi-inbox" style="font-size: 2rem; color: #ccc; margin-right: 10px;"></i>
          <p>Không có cấu hình ưu tiên nào</p>
        </td>
      </tr>
    </ng-template>
  </p-table>

  <!-- Add/Edit Dialog -->
  <p-dialog [visible]="showDialog" [header]="isEditMode ? 'Sửa Cấu hình Ưu Tiên' : 'Thêm Cấu hình Ưu Tiên'" 
    [modal]="true" [closable]="true" [draggable]="false" (onHide)="showDialog = false" [style]="{width: '500px'}">
    <div class="dialog-content">
      <div class="form-group">
        <label>Dịch vụ (tùy chọn)</label>
        <p-dropdown [options]="services" optionLabel="serviceName" optionValue="serviceId" 
          [(ngModel)]="formData.serviceId" placeholder="Chọn dịch vụ hoặc để trống cho toàn bộ"
          [showClear]="true" appendTo="body"></p-dropdown>
      </div>

      <div class="form-group">
        <label>Phòng (tùy chọn)</label>
        <p-dropdown [options]="rooms" optionLabel="roomName" optionValue="roomId" 
          [(ngModel)]="formData.roomId" placeholder="Chọn phòng hoặc để trống cho toàn bộ"
          [showClear]="true" appendTo="body"></p-dropdown>
      </div>

      <div class="form-group">
        <label>Chiến lược ưu tiên *</label>
        <p-dropdown [options]="strategyOptions" optionLabel="label" optionValue="value" 
          [(ngModel)]="formData.strategy" (onChange)="onStrategyChange($event)" 
          placeholder="Chọn chiến lược" appendTo="body"></p-dropdown>
      </div>

      <div class="form-group" *ngIf="isInterleavedStrategy()">
        <label>Khoảng cách xen kẽ *</label>
        <p-inputNumber [(ngModel)]="formData.interleaveInterval" [min]="1" [step]="1"></p-inputNumber>
        <small>Số phiếu thường trên 1 phiếu ưu tiên (mặc định: 5)</small>
      </div>

      <div class="form-group">
        <label>Trạng thái</label>
        <p-inputSwitch [(ngModel)]="formData.isActive"></p-inputSwitch>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <button pButton type="button" label="Hủy" icon="pi pi-times" class="p-button-text" (click)="showDialog = false"></button>
      <button pButton type="button" [label]="isEditMode ? 'Cập nhật' : 'Thêm'" icon="pi pi-check" 
        class="p-button-primary" (click)="saveSettings()" [loading]="isLoading"></button>
    </ng-template>
  </p-dialog>

  <!-- Confirmation Dialog -->
  <p-confirmDialog [style]="{width: '450px'}"></p-confirmDialog>

  <!-- Toast Messages -->
  <p-toast></p-toast>
</div>
